<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="DiaryTaskManagerApp.Features.Tasks.Views.TasksPage"
    x:Name="PageRoot"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:models="clr-namespace:DiaryTaskManagerApp.Core.Models"
    xmlns:vm="clr-namespace:DiaryTaskManagerApp.Features.Tasks.ViewModels"
    xmlns:behaviors="clr-namespace:DiaryTaskManagerApp.Features.Tasks.Behaviors"
    xmlns:infra="clr-namespace:DiaryTaskManagerApp.Infrastructure"
    x:DataType="vm:TasksPageViewModel"
    BackgroundColor="{StaticResource AppBg}">

    <ContentPage.Resources>
        <infra:InvertedBoolConverter x:Key="InvertedBoolConverter" />
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,Auto,*,Auto" Padding="16,12,16,12" RowSpacing="14">

        <!-- Header: menu + avatar + username + flames + profile -->
        <Grid Grid.Row="0" ColumnDefinitions="Auto,Auto,*,Auto" ColumnSpacing="10">
            <Border Grid.Column="0"
                    WidthRequest="48"
                    HeightRequest="48"
                    BackgroundColor="{StaticResource Surface}"
                    StrokeThickness="0"
                    VerticalOptions="Center">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="16" />
                </Border.StrokeShape>
                <Border.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnMenuTapped" />
                </Border.GestureRecognizers>
                <Image Source="menu_icon.svg" WidthRequest="24" HeightRequest="24" HorizontalOptions="Center" VerticalOptions="Center" />
            </Border>
            <Border Grid.Column="1"
                    WidthRequest="48"
                    HeightRequest="48"
                    StrokeThickness="0"
                    VerticalOptions="Center">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="24" />
                </Border.StrokeShape>
                <Grid>
                    <Border BackgroundColor="{StaticResource Surface2}"
                            IsVisible="{Binding HasAvatar, Converter={StaticResource InvertedBoolConverter}}">
                        <Label Text="ðŸ‘¤"
                               FontSize="28"
                               HorizontalOptions="Center"
                               VerticalOptions="Center" />
                    </Border>
                    <Image Source="{Binding AvatarPath}"
                           Aspect="AspectFill"
                           IsVisible="{Binding HasAvatar}" />
                </Grid>
            </Border>

            <HorizontalStackLayout Grid.Column="2" Spacing="8" VerticalOptions="Center" HorizontalOptions="Start">
                <Label Text="{Binding UserName}"
                       FontSize="18"
                       FontAttributes="Bold"
                       TextColor="{StaticResource White}"
                       LineBreakMode="TailTruncation"
                       MaxLines="1"
                       MaximumWidthRequest="120" />

                <Border IsVisible="{Binding HasFlames}"
                        BackgroundColor="{StaticResource Surface2}"
                        Padding="8,5"
                        StrokeThickness="0"
                        VerticalOptions="Center">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12" />
                    </Border.StrokeShape>
                    <Label Text="{Binding FlamesText}"
                           FontSize="13"
                           TextColor="{StaticResource White}" />
                </Border>
            </HorizontalStackLayout>

            <Border Grid.Column="3"
                    BackgroundColor="{StaticResource Surface}"
                    Padding="10,8"
                    StrokeThickness="0"
                    VerticalOptions="Center"
                    HorizontalOptions="End">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="14" />
                </Border.StrokeShape>
                <Border.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnProfileTapped" />
                </Border.GestureRecognizers>
                <Label Text="Profile"
                       FontSize="13"
                       TextColor="{StaticResource White}" />
            </Border>
        </Grid>

        <!-- Filters / sort -->
        <Border Grid.Row="1" BackgroundColor="{StaticResource Surface}" StrokeThickness="0">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="20" />
            </Border.StrokeShape>
            <Grid Padding="16,14" ColumnDefinitions="*,*" ColumnSpacing="12">
                <Picker Grid.Column="0"
                        Title="Filter"
                        ItemsSource="{Binding FilterOptions}"
                        SelectedIndex="{Binding SelectedFilterIndex}"
                        FontSize="15"
                        TextColor="{StaticResource White}"
                        MinimumHeightRequest="48" />
                <Picker Grid.Column="1"
                        Title="Sort"
                        ItemsSource="{Binding SortOptions}"
                        SelectedIndex="{Binding SelectedSortIndex}"
                        FontSize="15"
                        TextColor="{StaticResource White}"
                        MinimumHeightRequest="48" />
            </Grid>
        </Border>

        <!-- List -->
        <CollectionView Grid.Row="2" ItemsSource="{Binding Tasks}" SelectionMode="None">
            <CollectionView.EmptyView>
                <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="12">
                    <Label Text="ðŸ“"
                           FontSize="64"
                           HorizontalOptions="Center"
                           Opacity="0.3" />
                    <Label Text="No tasks"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{StaticResource TextSecondary}"
                           HorizontalOptions="Center" />
                    <Label Text="Add your first task below"
                           FontSize="14"
                           TextColor="{StaticResource TextSecondary}"
                           HorizontalOptions="Center" />
                </VerticalStackLayout>
            </CollectionView.EmptyView>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:TaskItem">
                    <SwipeView Margin="0,0,0,12">
                        <SwipeView.RightItems>
                            <SwipeItems Mode="Execute" SwipeBehaviorOnInvoked="Close">
                                <SwipeItem Text="Delete"
                                           BackgroundColor="#D32F2F"
                                           Invoked="OnSwipeDelete" />
                            </SwipeItems>
                        </SwipeView.RightItems>
                        
                        <Border Padding="16"
                                BackgroundColor="{StaticResource Surface}"
                                StrokeThickness="0">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="16" />
                            </Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnTaskTapped" />
                                <PointerGestureRecognizer PointerPressed="OnTaskPressed" PointerReleased="OnTaskReleased" PointerExited="OnTaskExited" />
                            </Border.GestureRecognizers>

                            <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="14">
                            <Border Grid.RowSpan="3"
                                    WidthRequest="48"
                                    HeightRequest="48"
                                    BackgroundColor="{StaticResource Surface2}"
                                    VerticalOptions="Center">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="12" />
                                </Border.StrokeShape>
                                <Label Text="{Binding Emoji}"
                                       FontSize="26"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding IsCompleted}" Value="True">
                                            <Setter Property="Opacity" Value="0.5" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                            </Border>

                            <Label Grid.Column="1"
                                   Text="{Binding Title}"
                                   FontAttributes="Bold"
                                   LineBreakMode="TailTruncation"
                                   MaxLines="2"
                                   FontSize="17"
                                   TextColor="{StaticResource White}">
                                <Label.Triggers>
                                    <DataTrigger TargetType="Label" Binding="{Binding IsCompleted}" Value="True">
                                        <Setter Property="TextDecorations" Value="Strikethrough" />
                                        <Setter Property="Opacity" Value="0.6" />
                                    </DataTrigger>
                                </Label.Triggers>
                            </Label>

                            <Label Grid.Row="1"
                                   Grid.Column="1"
                                   Text="{Binding CreatedAtText}"
                                   FontSize="13"
                                   TextColor="{StaticResource TextSecondary}"
                                   Margin="0,4,0,0" />

                            <Label Grid.Row="2"
                                   Grid.Column="1"
                                   Text="{Binding CompletedAtText}"
                                   FontSize="13"
                                   TextColor="#2E7D32"
                                   Margin="0,2,0,0"
                                   IsVisible="{Binding IsCompleted}" />
                            </Grid>
                        </Border>
                    </SwipeView>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Bottom input -->
        <Border Grid.Row="3" BackgroundColor="{StaticResource Surface}" StrokeThickness="0">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="24" />
            </Border.StrokeShape>
            <Grid Padding="10" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                <!-- Importance toggle button -->
                <Border Grid.Column="0"
                        WidthRequest="56"
                        HeightRequest="56"
                        BackgroundColor="{StaticResource Surface2}">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="16" />
                    </Border.StrokeShape>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding CycleImportanceCommand}" />
                    </Border.GestureRecognizers>
                    <Label Text="{Binding CurrentImportanceEmoji}"
                           FontSize="30"
                           HorizontalOptions="Center"
                           VerticalOptions="Center" />
                </Border>

                <!-- Input field -->
                <Border Grid.Column="1"
                        BackgroundColor="{StaticResource Surface2}"
                        Padding="16,0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="16" />
                    </Border.StrokeShape>
                    <Entry Placeholder="New task..."
                           PlaceholderColor="{StaticResource TextSecondary}"
                           Text="{Binding NewTaskText}"
                           ReturnType="Send"
                           ReturnCommand="{Binding AddTaskCommand}"
                           TextColor="{StaticResource White}"
                           FontSize="16"
                           MinimumHeightRequest="48"
                           VerticalOptions="Center" />
                </Border>

                <!-- Send button -->
                <Border Grid.Column="2"
                        WidthRequest="56"
                        HeightRequest="56">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="16" />
                    </Border.StrokeShape>
                    <Border.Background>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                            <GradientStop Color="#00E5FF" Offset="0.0" />
                            <GradientStop Color="#00B8D4" Offset="1.0" />
                        </LinearGradientBrush>
                    </Border.Background>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding AddTaskCommand}" />
                    </Border.GestureRecognizers>
                    <Image Source="send_icon.svg" WidthRequest="28" HeightRequest="28" HorizontalOptions="Center" VerticalOptions="Center" />
                </Border>
            </Grid>
        </Border>

    </Grid>
</ContentPage>


